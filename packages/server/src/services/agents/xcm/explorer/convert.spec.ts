import { describe, expect, it } from 'vitest'
import { HumanizedXcm, XcmJourneyType } from '@/services/agents/xcm/humanize/types.js'
import { getHydrationWormholeTokenBridgeXcm } from '@/testing/humanize.js'
import { toNewAssets } from './convert.js'

const testHumanizedXcm: HumanizedXcm = {
  type: XcmJourneyType.Transact,
  from: { key: '0x36675cb19cb6c796b02d3b842595c72e7da4aea8' },
  to: { key: '0x870348d8035b168f1fbdbf245ced030941bbf5fc' },
  assets: [
    {
      id: 'urn:ocn:polkadot:2004|native',
      amount: 900000000000000000n,
      role: 'transfer',
      sequence: undefined,
      volume: undefined,
    },
  ],
  version: 'V4',
  transactCalls: [
    {
      module: 'EthereumXcm',
      method: 'transact',
      args: {},
      raw: '0x6d0000404b4c0000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000008080000000000000000000000000000000000000000000000000000000000000000110d96e292b8000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000da430218862d3db25de9f61458645dde49a9e9c1000000000000000000000000b1731c586ca89a23809861c6103f0b96b3f57d920000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000b1731c586ca89a23809861c6103f0b96b3f57d920000000000000000000000000000000000000000000011fe97217d3cb97d7cca0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c40f5287b0000000000000000000000000da430218862d3db25de9f61458645dde49a9e9c10000000000000000000000000000000000000000000011fe97217d3cb97d7cca000000000000000000000000000000000000000000000000000000000000000200000000000000000000000036675cb19cb6c796b02d3b842595c72e7da4aea80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
    },
  ],
  xprotocolData: {
    type: 'wormhole',
    protocol: 'wh_portal',
    destination: 'urn:ocn:ethereum:1',
    beneficiary: { key: '0x36675cb19cb6c796b02d3b842595c72e7da4aea8' },
    assets: [
      {
        id: 'urn:ocn:polkadot:2004|0xda430218862d3db25de9f61458645dde49a9e9c1',
        amount: 84976593326579916831946n,
        role: 'transfer',
        sequence: 0,
      },
    ],
  },
}

describe('toNewAssets', () => {
  it('should merge humanized and xprotocol assets without duplicates', () => {
    const msg = getHydrationWormholeTokenBridgeXcm()
    const payload = { ...msg, humanized: testHumanizedXcm }

    const result = toNewAssets(payload)

    expect(result).toHaveLength(2)
    expect(result[0].amount).toBe('900000000000000000')
    expect(result[1].amount).toBe('84976593326579916831946')
  })
})
